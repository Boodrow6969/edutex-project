import { aiService } from './index';
import { NeedsAnalysisResult } from '@/lib/types/needsAnalysis';

/**
 * Convert raw SME notes into structured task lists
 */
export async function convertNotesToTaskList(notes: string): Promise<string> {
  const response = await aiService.complete({
    provider: 'openai', // Good for structured extraction
    messages: [
      {
        role: 'system',
        content: `You are an expert instructional designer. Your task is to analyze subject matter expert (SME) notes and convert them into a clear, structured task list for training development.

Extract concrete, actionable tasks from the notes. Each task should be:
- Specific and measurable
- Focused on a single action or outcome
- Written in clear, professional language
- Relevant to instructional design or training development

Format the output as a numbered list.`,
      },
      {
        role: 'user',
        content: `Convert these SME notes into a structured task list:\n\n${notes}`,
      },
    ],
    temperature: 0.5,
    maxTokens: 1500,
  });

  return response.content;
}

/**
 * Generate measurable learning objectives from performance descriptions
 */
export async function generateLearningObjectives(
  performanceDescription: string,
  context?: string
): Promise<Array<{ objective: string; bloomLevel: string; rationale: string }>> {
  const contextPrompt = context
    ? `\n\nAdditional context: ${context}`
    : '';

  const response = await aiService.complete({
    provider: 'anthropic', // Good for structured, analytical outputs
    messages: [
      {
        role: 'system',
        content: `You are an expert instructional designer specializing in learning objectives. Your task is to create measurable learning objectives following SMART criteria and Bloom's Taxonomy.

For each objective:
1. Use action verbs appropriate to Bloom's Taxonomy level
2. Make it measurable and observable
3. Focus on learner performance, not instructor activities
4. Be specific about what learners will be able to do

Return your response as a JSON array with this structure:
[
  {
    "objective": "The learner will be able to...",
    "bloomLevel": "Remember|Understand|Apply|Analyze|Evaluate|Create",
    "rationale": "Brief explanation of why this level was chosen"
  }
]`,
      },
      {
        role: 'user',
        content: `Generate 3-5 learning objectives for this performance requirement:\n\n${performanceDescription}${contextPrompt}`,
      },
    ],
    temperature: 0.6,
    maxTokens: 2000,
  });

  try {
    // Try to parse JSON response
    const parsed = JSON.parse(response.content);
    return Array.isArray(parsed) ? parsed : [];
  } catch {
    // If not JSON, return structured interpretation
    return [
      {
        objective: response.content,
        bloomLevel: 'Apply',
        rationale: 'Generated from AI response',
      },
    ];
  }
}

/**
 * Suggest assessment ideas aligned with objectives and Bloom level
 */
export async function suggestAssessments(
  objective: string,
  bloomLevel: string
): Promise<string> {
  const response = await aiService.complete({
    messages: [
      {
        role: 'system',
        content: `You are an expert in assessment design for instructional design. Generate assessment ideas that are:
- Aligned with the learning objective and Bloom's Taxonomy level
- Authentic and practical
- Measurable and observable
- Appropriate for adult learners in professional training

Provide 2-3 specific assessment ideas with brief descriptions.`,
      },
      {
        role: 'user',
        content: `Suggest assessment ideas for this learning objective (Bloom level: ${bloomLevel}):\n\n${objective}`,
      },
    ],
    temperature: 0.7,
    maxTokens: 1000,
  });

  return response.content;
}

/**
 * Analyze needs analysis content and extract key insights, audience notes,
 * constraints, and recommended tasks for the instructional design project.
 */
export async function analyzeNeedsAnalysis(content: string): Promise<NeedsAnalysisResult> {
  const response = await aiService.complete({
    provider: 'anthropic', // Good for long-form analysis
    messages: [
      {
        role: 'system',
        content: `You are an expert instructional designer analyzing a needs analysis document. Extract and structure the following information:

1. Summary: A concise 2-3 sentence overview of the training need
2. Key Insights: Important observations about performance gaps, business impact, and training needs
3. Audience Notes: Description of the target audience, their current skills, and learning preferences
4. Constraints: Any limitations identified (time, budget, technology, organizational, etc.)
5. Recommended Tasks: Specific actionable tasks for the instructional design project

Return your analysis as JSON with this exact structure:
{
  "summary": "Brief 2-3 sentence summary...",
  "keyInsights": ["insight 1", "insight 2", "..."],
  "audienceNotes": "Description of target audience...",
  "constraints": ["constraint 1", "constraint 2", "..."],
  "recommendedTasks": [
    { "title": "Task title", "priority": "HIGH|MEDIUM|LOW|URGENT", "description": "Optional brief description" }
  ]
}

For recommendedTasks, include 3-7 concrete tasks that would help develop the training solution. Assign priority based on:
- URGENT: Critical blockers or dependencies
- HIGH: Essential tasks for project success
- MEDIUM: Important but not blocking
- LOW: Nice-to-have or future considerations`,
      },
      {
        role: 'user',
        content: `Analyze this needs analysis content and extract structured insights:\n\n${content}`,
      },
    ],
    temperature: 0.5,
    maxTokens: 2500,
  });

  try {
    const parsed = JSON.parse(response.content);
    // Ensure all required fields exist with defaults
    return {
      summary: parsed.summary || '',
      keyInsights: Array.isArray(parsed.keyInsights) ? parsed.keyInsights : [],
      audienceNotes: parsed.audienceNotes || '',
      constraints: Array.isArray(parsed.constraints) ? parsed.constraints : [],
      recommendedTasks: Array.isArray(parsed.recommendedTasks)
        ? parsed.recommendedTasks.map((task: { title?: string; priority?: string; description?: string }) => ({
            title: task.title || 'Untitled Task',
            priority: ['LOW', 'MEDIUM', 'HIGH', 'URGENT'].includes(task.priority || '')
              ? task.priority
              : 'MEDIUM',
            description: task.description,
          }))
        : [],
    };
  } catch {
    // Fallback if JSON parsing fails
    return {
      summary: response.content,
      keyInsights: [],
      audienceNotes: '',
      constraints: [],
      recommendedTasks: [],
    };
  }
}

/**
 * Generate executive summary for stakeholders
 */
export async function generateExecutiveSummary(
  projectData: {
    needsAnalysis?: string;
    objectives?: string[];
    deliverables?: string[];
  }
): Promise<string> {
  const content = `
Needs Analysis: ${projectData.needsAnalysis || 'Not provided'}
Learning Objectives: ${projectData.objectives?.join(', ') || 'Not provided'}
Deliverables: ${projectData.deliverables?.join(', ') || 'Not provided'}
  `.trim();

  const response = await aiService.complete({
    messages: [
      {
        role: 'system',
        content: `You are an expert at creating executive summaries for training projects. Create a concise, professional summary (250-300 words) that:
- Highlights the business problem and training solution
- Summarizes key objectives and outcomes
- Mentions major deliverables
- Uses clear, non-technical language suitable for executives
- Focuses on business impact and ROI`,
      },
      {
        role: 'user',
        content: `Create an executive summary from this project information:\n\n${content}`,
      },
    ],
    temperature: 0.6,
    maxTokens: 800,
  });

  return response.content;
}
